#!/usr/bin/env sh

# What goes in here:
# Things that are not inherited in sub-shells.
# - Aliases
# - Functions
# - Options that can be set across bash and zsh.

# NOTE: OS variables are exported by koopa. This is defined in shprofile, which
# should get sourced before this file.

# Enable for debugging.
# export SHRC=1

add_to_path_start() {
    [ -d "$1" ] || return
    export PATH="$1:$PATH"
}

# Regular expression matching that is POSIX compliant
# https://stackoverflow.com/questions/21115121
# Avoid using `[[ =~ ]]` in sh config files.
# expr is faster than using case
quiet_expr() {
    expr "$1" : "$2" 1>/dev/null
}

# Don't use `&>` here, it isn't POSIX.
# https://unix.stackexchange.com/a/80632
quiet_which() {
    command -v "$1" >/dev/null 2>&1
}

# alias be="noglob bundle exec"
# alias gist="gist --open --copy"
# alias ls="ls -Fhlo --color"
# alias make="nice make"
# alias rake="noglob rake"
# alias rg="rg --colors 'match:style:nobold' --colors 'path:style:nobold'"
# alias rsync="rsync --partial --progress --human-readable --compress"
# alias svn="svn-git.sh"
# alias zmv="noglob zmv -vW"

# Enable colors (for dircolors).
# alias dir="dir --color=auto"
# alias egrep="egrep --color=auto"
# alias fgrep="fgrep --color=auto"
# alias grep="grep --color=auto"
# alias ls="ls --color=auto"
# alias vdir="vdir --color=auto"

# How to copy to Azure shares without error.
# Note that timestamps and permissions are not maintained.
# -R, --recursive
# -L, --dereference
# -u, --update
# -v, --verbose
# cp -RLuv data seq01

# Quick exit.
alias e="exit"

# Improve common file system command defaults.
alias cp="cp -irv"
alias mkdir="mkdir -vp"
alias mv="mv -iv"
alias rm="rm -iv"

# Listing files.
alias la="ls -a"
alias lF="ls -F"
alias ll="ls -AFGlh"

# Set more sensible defaults for size commands.
alias df="df -H"
alias du="du -sh"

# Improve less defaults.
alias less="less --ignore-case --raw-control-chars"

# Easier checksum calculation.
alias sha256="shasum -a 256"

# Emacs. Use terminal mode by default instead of window system.
alias emacs="emacs --no-window-system"

# Disable R prompt to save workspace.
# --no-environ
# --no-init
# --no-restore
# --no-save
# --vanilla
alias R="R --no-restore --no-save"

# Run dircolors, if it exists.
quiet_which dircolors && eval "$(dircolors -b)"

# Fake realpath support, if necessary.
if [ -z "$(quiet_which realpath)" ]
then
    alias realpath="readlink -f"
fi

if [ "$(uname -s)" = "Darwin" ]
then
    # Use exa instead of ls, if installed.
    # It has better color support.
    # https://the.exa.website/
    if quiet_which exa
    then
        alias ls="exa -Fg"
    else
        alias ls="ls -F"
    fi

    # Call personal scripts prefixed with "mjs".
    # Currently this is macOS-specific.
    mjs() {
        script="$1"
        shift 1
        # shellcheck source=/dev/null
        # shellcheck disable=SC2240
        bash "${HOME}/git/bash/${script}.sh" "$@"
        unset -v script
    }

    # Create the today directory in bucket automatically.
    mjs bucket

    # Aliases
    alias autofs="sudo automount -vc"
    alias finder-hide="setfile -a V"
    alias icloud-status="brctl log --wait --shorten"
    alias locate="mdfind -name"
    alias rstudio="open -a rstudio"
fi
