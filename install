#!/usr/bin/env bash
set -Eeu -o pipefail

# shellcheck source=/dev/null
checks=0 source "$(koopa header bash)"
prefix="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"

name_fancy="dotfiles"

_koopa_install_start "$name_fancy"

# Check that the prefix matches what koopa is expecting.
expected_prefix="$(_koopa_dotfiles_prefix)"
_koopa_assert_are_identical \
    "$(realpath "$prefix")" \
    "$(realpath "$expected_prefix")"

# > rm -frv ~/.zcompdump
rm -frv ~/.*-history
rm -frv ~/.R/Makevars
rm -frv ~/.kshrc
rm -frv ~/.oh-my-zsh
rm -frv ~/.profile
rm -frv ~/.shrc
rm -frv ~/.zprofile

# Placeholder for using "main" instead of "master" for default git branch.
# Inspired by https://github.com/mathiasbynens/dotfiles
# > link-dotfile --force --config app/git/template git/template

link-dotfile --force --config app/emacs/doom/config.d doom
link-dotfile --force --config app/htop
link-dotfile --force --config app/neofetch
link-dotfile --force --config app/nvim
link-dotfile --force --config shell/fish
link-dotfile --force app/curl/curlrc
link-dotfile --force app/editorconfig/editorconfig
link-dotfile --force app/emacs/spacemacs/spacemacs.el spacemacs
link-dotfile --force app/git/gitignore
link-dotfile --force app/gnupg/dirmngr.conf gnupg/dirmngr.conf
link-dotfile --force app/python/pylintrc
link-dotfile --force app/screen/screenrc
link-dotfile --force app/terminfo/terminfo.d terminfo
link-dotfile --force app/tmux/tmux.conf
link-dotfile --force app/tmux/tmux.d tmux
link-dotfile --force app/vim/vim.d vim
link-dotfile --force app/vim/vimrc
link-dotfile --force app/wget/wgetrc
link-dotfile --force shell/bash/bash_logout
link-dotfile --force shell/bash/bash_profile
link-dotfile --force shell/bash/bashrc
link-dotfile --force shell/bash/inputrc
link-dotfile --force shell/posix/aliases
link-dotfile --force shell/posix/shrc
link-dotfile --force shell/zsh/zlogout
link-dotfile --force shell/zsh/zshrc

if _koopa_is_macos
then
    link-dotfile --force --config app/alacritty
    link-dotfile --force app/vim/gvimrc
    link-dotfile --force os/macos/app/gnupg/gpg-agent.conf gnupg/gpg-agent.conf
else
    link-dotfile --force app/gnupg/gpg-agent.conf gnupg/gpg-agent.conf
fi

# Permission fixes.
[[ -d ~/.gnupg ]] && chmod 0700 ~/.gnupg
[[ -d ~/.ssh ]] && chmod 0700 ~/.ssh

_koopa_install_success "$name_fancy"
