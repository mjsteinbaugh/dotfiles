#!/usr/bin/env bash
set -Eeu -o pipefail

export KOOPA_CHECKS=0
# shellcheck source=/dev/null
source "$(koopa header bash)"
prefix="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"

link() {
    koopa::link_dotfile --force "$@"
}

install() {
    # """
    # Install dotfiles.
    # @note Updated 2021-06-07.
    # """
    local name_fancy
    name_fancy='dotfiles'
    koopa::install_start "$name_fancy"
    expected_prefix="$(koopa::dotfiles_prefix)"
    koopa::assert_are_identical \
        "$(koopa::realpath "$prefix")" \
        "$(koopa::realpath "$expected_prefix")"
    koopa::add_config_link "$prefix" 'dotfiles'
    koopa::rm \
        "${HOME}/.R/Makevars" \
        "${HOME}/.config/doom" \
        "${HOME}/.config/libreoffice" \
        "${HOME}/.kshrc" \
        "${HOME}/.oh-my-zsh" \
        "${HOME}/.shrc" \
        "${HOME}/.tmux" \
        "${HOME}/.zprofile"
    link --config 'app/broot'
    link --config 'app/hadolint/hadolint.yaml' 'hadolint.yaml'
    link --config 'app/htop'
    link --config 'app/kakoune' 'kak'
    link --config 'app/neofetch'
    link --config 'app/nvim'
    link --config 'app/pip'
    link --config 'app/ranger'
    link --config 'app/rstudio'
    link --config 'app/starship/starship.toml' 'starship.toml'
    link --config 'shell/fish'
    link --config 'shell/oil'
    link 'app/ack/ackrc'
    link 'app/chemacs/emacs-profiles.el'
    link 'app/curl/curlrc'
    link 'app/doom' 'doom.d'
    link 'app/editorconfig/editorconfig'
    link 'app/git/gitignore'
    link 'app/gnupg/dirmngr.conf' 'gnupg/dirmngr.conf'
    link 'app/npm/npmrc'
    link 'app/pylint/pylintrc'
    link 'app/python/pyrc'
    link 'app/screen/screenrc'
    link 'app/spacemacs/spacemacs.el' 'spacemacs'
    link 'app/terminfo/terminfo.d' 'terminfo'
    link 'app/tmux/tmux.conf'
    link 'app/vim/vim.d' 'vim'
    link 'app/vim/vimrc'
    link 'app/wget/wgetrc'
    link 'shell/bash/bash_logout'
    link 'shell/bash/bash_profile'
    link 'shell/bash/bashrc'
    link 'shell/bash/inputrc'
    link 'shell/posix/aliases'
    link 'shell/posix/profile'
    link 'shell/zsh/zlogout'
    link 'shell/zsh/zshrc'
    # Placeholder for using "main" instead of "master" for default git branch.
    # Inspired by https://github.com/mathiasbynens/dotfiles
    # > link --config 'app/git/template' 'git/template'
    if koopa::is_macos
    then
        link --config 'app/alacritty'
        link 'app/vim/gvimrc'
        link 'os/macos/app/gnupg/gpg-agent.conf' 'gnupg/gpg-agent.conf'
    elif koopa::is_linux
    then
        link 'app/gnupg/gpg-agent.conf' 'gnupg/gpg-agent.conf'
        if koopa::is_ubuntu
        then
            link 'os/linux/distro/ubuntu/hushlogin'
        fi
    fi
    if [[ -d "${HOME}/.gnupg" ]]
    then
        koopa::chmod 0700 "${HOME}/.gnupg"
    fi
    if [[ -d "${HOME}/.ssh" ]]
    then
        koopa::chmod 0700 "${HOME}/.ssh"
    fi
    koopa::install_success "$name_fancy"
    return 0
}

install "$@"
